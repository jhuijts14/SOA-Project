<!-- bikeDealer BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Sun Jan 15 19:56:42 CET 2012 -->
<bpel:process name="bikeDealer" 
	targetNamespace="http://bikeDealer/dealer/"
	suppressJoinFailure="yes" 
	xmlns:tns="http://bikeDealer/dealer/"
	xmlns:cb="http://bikeDealer/offerCallback/" 
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:bk="http://bikeDealer/bike/" 
	xmlns:off="http://bikeDealer/offer/"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

	<!-- Import the client WSDLs -->

	<bpel:import location="bikeDealer.wsdl" namespace="http://bikeDealer/dealer/"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="offerCallback.wsdl" namespace="http://bikeDealer/offerCallback/"
		importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- Import the server WSDLs -->

	<bpel:import namespace="http://bikeDealer/bike/" location="bike.wsdl"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import namespace="http://bikeDealer/offer/" location="offer.wsdl"
		importType="http://schemas.xmlsoap.org/wsdl/" />
		
		
	<bpel:correlationSets>
		<bpel:correlationSet name="BikeID" properties="tns:bikeID" />
	</bpel:correlationSets>


	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- =========================================================== -->

	<bpel:partnerLinks>
		<bpel:partnerLink name="client" partnerLinkType="tns:BikeDealer"
			myRole="dealer" />
		<bpel:partnerLink name="bike" partnerLinkType="tns:Bike"
			partnerRole="directory" />
		<bpel:partnerLink name="offer" partnerLinkType="tns:Offer"
			partnerRole="manager" myRole="acceptor" />
	</bpel:partnerLinks>

	<bpel:variables>
		<bpel:variable name="offer" messageType="tns:UserOfferRequest" />
		<bpel:variable name="ownerIdReq" messageType="bk:getOwnerIDRequest" />
		<bpel:variable name="ownerId" messageType="bk:getOwnerIDResponse" />
		<bpel:variable name="callBackReq" messageType="cb:ReceiveCallBackRequest" />
		<bpel:variable name="offerResp" messageType="tns:UserOfferResponse" />
		<bpel:variable name="offerReq" messageType="off:receiveOfferRequest"/>
	</bpel:variables>

	<bpel:sequence name="main">
		<bpel:receive name="Receive-offer" partnerLink="client"
			portType="tns:BikeDealer" operation="userOffer" variable="offer"
			createInstance="yes">
			<bpel:correlations>
				<bpel:correlation set="BikeID" initiate="yes" />
			</bpel:correlations>
		</bpel:receive>

		<bpel:assign validate="no" name="Assign-bikeID">
			<bpel:copy>
				<bpel:from>$offer.offer/bikeID</bpel:from>
				<bpel:to>$ownerIdReq.bikeID</bpel:to>
			</bpel:copy>
		</bpel:assign>

		<bpel:invoke name="Invoke-bike-getOwnerID" partnerLink="bike"
			operation="getOwnerID" portType="bk:Bike" inputVariable="ownerIdReq"
			outputVariable="ownerId"></bpel:invoke>

		<bpel:assign validate="no" name="Assign-offer">
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<off:UserOffer>
							<bikeID>bike01</bikeID>
							<priceOffer>10000</priceOffer>
							<ownerID>owner01</ownerID>
						</off:UserOffer>
					</bpel:literal>
				</bpel:from>
				<bpel:to>$offerReq.userOffer</bpel:to>
			</bpel:copy>

			<bpel:copy>
				<bpel:from>$offer.offer/bikeID</bpel:from>
				<bpel:to>$offerReq.userOffer/bikeID</bpel:to>
			</bpel:copy>

			<bpel:copy>
				<bpel:from>$offer.offer/priceOffer</bpel:from>
				<bpel:to>$offerReq.userOffer/priceOffer</bpel:to>
			</bpel:copy>

			<bpel:copy>
				<bpel:from>$ownerId.ownerID</bpel:from>
				<bpel:to>$offerReq.userOffer/ownerID</bpel:to>
			</bpel:copy>
		</bpel:assign>

		<bpel:invoke name="Invoke-offer-receiveOffer" partnerLink="offer"
			operation="receiveOffer" portType="off:Offer" inputVariable="offerReq" />
		<bpel:receive name="Receive-offerCallback" partnerLink="offer"
			operation="receiveCallBack" portType="cb:OfferCallback" variable="callBackReq">
			<bpel:correlations>
				<bpel:correlation set="BikeID" initiate="no" />
			</bpel:correlations>
		</bpel:receive>
		<bpel:assign validate="no" name="Assign-response">
			<bpel:copy>
				<bpel:from variable="callBackReq" part="callbackReq">
				<bpel:query>OwnerAnswer</bpel:query>
				</bpel:from>
				<bpel:to variable="offerResp" part="result"/>
			</bpel:copy>
		</bpel:assign>
		<bpel:reply name="Reply-offer" partnerLink="client"
			operation="userOffer" portType="tns:BikeDealer" variable="offerResp"></bpel:reply>
	</bpel:sequence>
</bpel:process>

